<!DOCTYPE html>
<html style='width:100%; height:100%; border:0; margin:0; padding:0;'>

<body style='height:95%; background: linear-gradient(Grey 0%, White 100%);'>

    <script src="/jquery/dist/jquery.min.js"></script>
    <script src="/x3dom/x3dom.js"></script>
    <script src="/socket.io-client/dist/socket.io.min.js"></script>
    <script src="/touch/x3domTouch.js"></script>
    <link rel='stylesheet' type='text/css' href='/x3dom/x3dom.css' />

    <style>
        #inputTypeLabel {
            position: fixed;
            left: 0;
            top: 0;
            width: 200px;
            margin: 24px;
            padding: 8px;
            background: #888888;
            background: linear-gradient(#BBBBBB, #888888);
            border-radius: 8px;
            border: 2px solid #EEEEEE;
            box-shadow: 3px 3px 3px rgba(0, 0, 0, 0.25);
            font-weight: bold;
            color: white;
            z-index: 20000;
        }
    </style>

    <script>
        var socket = io.connect('http://localhost:4200');
        socket.on('connect', function (data) {
            socket.emit('join', 'Ready');
        });

        socket.on('disable', function (data) {
            var sensors = [
                'redSlider',
                'greenSlider',
                'blueSlider',
                'redRing',
                'blueRing'
            ];
            var elements = [
                'redSliderColor',
                'greenSliderColor',
                'blueSliderColor',
                'redRingColor',
                'blueRingColor',
                'coaster1',
                'coaster2',
                'coaster3',
                'coaster4',
                'stopper1',
                'stopper2',
                'stopper3',
                'stopper4',
                'stopper5',
                'stopper6',
                'line1',
                'line2',
                'line3'
            ];

            if (!data && crawling) {
                resetPos();
                crawling = false;
            } else if (data && !crawling) {
                resetCoords();
                crawling = true;
            } else {
                return;
            }
            for (var i = 0; i < 5; i++) {
                document.getElementById(sensors[i]).setAttribute('enabled', !data);
            }
            for (var i = 0; i < 18; i++) {
                document.getElementById(elements[i]).setAttribute('transparency', data ? 1 : 0);
            }
        });

        /*
         * This function mirrors the robot's movements while crawling. The
         * turning angles and crawling distances are just approximations
         * since the robot only sends the coordinates of its feet.
         */
        socket.on('mirror', function (legpos) {
            for (var leg in legpos) {
                var sensorToWorldMatrix, translationValue, rotationMatrixWorld;

                if (crawlMode === 'Forward' || crawlMode === 'Backward') {
                    var axisRotation = '1 0 0 -1.57';
                    var distance = new x3dom.fields.SFVec3f(0, 0, 0);
                    if (crawlMode === 'Forward')
                        xoffset += .025;
                    else
                        xoffset -= .025;
                    distance.x = xoffset;
                    distance = transformMatrix.inverse().multMatrixVec(distance);

                    //convert the sensor's output from sensor coordinates to world coordinates
                    sensorToWorldMatrix = x3dom.fields.SFMatrix4f.parseRotation(axisRotation);
                    translationValue = sensorToWorldMatrix.multMatrixVec(distance);

                    //transform the affected element
                    document.getElementById('quadrupedTranslation').setFieldValue('translation',
                        translationValue);
                    updateLeg(leg, legA[leg], legpos[leg]);
                }
                if (crawlMode === 'Left' || crawlMode === 'Right') {
                    var axisRotation = '0 1 0 -1.57';
                    var robotRotation = new x3dom.fields.Quaternion(0, 0.001, 0, 0.995);

                    if (crawlMode === 'Right')
                        robotRotation.y = -robotRotation.y;

                    sensorToWorldMatrix = x3dom.fields.SFMatrix4f.parseRotation(axisRotation);
                    rotationMatrixWorld = sensorToWorldMatrix.mult(robotRotation.toMatrix());

                    //create an offset that applies the current rotation in world coordinates,
                    //but doesn't change the orientation of the coordinate system
                    currentGizmoRotationOffset = rotationMatrixWorld.mult(sensorToWorldMatrix.inverse());
                    transformMatrix = currentGizmoRotationOffset.mult(currentGizmoRotation);

                    //incorporate the current rotation offset, interpreted globally, into the stored rotation value
                    //set matrix value in column major format, as required by the MatrixTransform node

                    var quadrupedRotationNode = document.getElementById('quadrupedRotation');
                    quadrupedRotationNode.setFieldValue("matrix", transformMatrix.transpose());
                    currentGizmoRotation = transformMatrix;
                    updateLeg(leg, legA[leg], legpos[leg]);
                }
            }
        });

        $("label").css({
            'font-family': 'arial'
        });

        var mode = 'Move';
        var crawling = false;
        var crawlMode;
        var transformMatrix;
        var currentGizmoRotation = new x3dom.fields.SFMatrix4f();
        var currentGizmoRotationOffset = new x3dom.fields.SFMatrix4f();
        var leg1a = {
            x: -2,
            y: 0,
            z: -2
        };
        var leg2a = {
            x: 2,
            y: 0,
            z: -2
        };
        var leg3a = {
            x: 2,
            y: 0,
            z: 2
        };
        var leg4a = {
            x: -2,
            y: 0,
            z: 2
        };
        var leg1b = {
            x: -4,
            y: 2,
            z: -4
        };
        var leg2b = {
            x: 4,
            y: 2,
            z: -4
        };
        var leg3b = {
            x: 4,
            y: 2,
            z: 4
        };
        var leg4b = {
            x: -4,
            y: 2,
            z: 4
        };
        var leg1c = {
            x: -6,
            y: -1,
            z: -6
        };
        var leg2c = {
            x: 6,
            y: -1,
            z: -6
        };
        var leg3c = {
            x: 6,
            y: -1,
            z: 6
        };
        var leg4c = {
            x: -6,
            y: -1,
            z: 6
        };
        var xoffset = 0,
            yoffset = 0,
            zoffset = 0;

        var legA = {
            leg1: leg1a,
            leg2: leg2a,
            leg3: leg3a,
            leg4: leg4a
        };

        $(function () {
            addLeg('leg1', leg1a, leg1b, leg1c);
            addLeg('leg2', leg2a, leg2b, leg2c);
            addLeg('leg3', leg3a, leg3b, leg3c);
            addLeg('leg4', leg4a, leg4b, leg4c);

            $("button").css({
                'width': '30%',
                'height': '50px',
                'font-size': '2em',
                'background-color': '#e6b800',
                'color': 'black',
                'margin': '5px'
            });

            $("button").click(function (event) {
                crawlMode = $(this).val();
                var myAudio = document.getElementById("audio" + crawlMode);
                socket.emit(crawlMode, "test");
                myAudio.play();
            });
        });

        function addLeg(leg, lega, legb, legc) {
            var legColor;
            for (var i = 0; i < 8; i++) {
                var delta = i * 0.1;
                var id = leg + '_' + i;
                var lid = leg + 'c' + i;
                legColor = '0.37 0.30 ' + (i / 50);
                var newpos = lega.x + ' ' + (lega.y - delta) + ' ' + lega.z +
                    ' ' + legb.x + ' ' + (legb.y - delta) + ' ' + legb.z +
                    ' ' + legc.x + ' ' + legc.y + ' ' + legc.z;
                var gobj = $('\
                           <transform> <shape id="' + id +
                    '">\
                                <appearance><material ambientintensity="0.2" emissiveColor="' +
                    legColor +
                    '"></material>\
                                <LineProperties linewidthScaleFactor=10 containerField="lineProperties"></LineProperties>\
                                </appearance>\
                                <LineSet id="' +
                    lid + '" vertexCount="3">\
                                <Coordinate point="' + newpos +
                    '"></Coordinate>\
                                </LineSet>\
                                </shape>\
                                </transform>'
                );

                $('#quadrupedRotation').append(gobj);
            }
        }

        function checkLeg(leg, p1, p2) {
            var xspan = (p1.x - p2.x);
            var yspan = (p1.y - p2.y);
            var zspan = (p1.z - p2.z);
            var halfspansquared = (Math.sqrt(xspan ** 2 + zspan ** 2 + yspan ** 2) / 2) ** 2;;
            var leglsquared = 12; // 2**2 + 2**2 + 2**2

            if (halfspansquared > leglsquared) {
                throw (leg + ' too far');
            }
        }

        function updateLeg(leg, p1, p2) {
            var xspan = (p1.x - p2.x);
            var yspan = (p1.y - p2.y);
            var zspan = (p1.z - p2.z);
            var halfspansquared = (Math.sqrt(xspan ** 2 + zspan ** 2 + yspan ** 2) / 2) ** 2;;
            var leglsquared = 12; // 2**2 + 2**2 + 2**2

            if (halfspansquared > leglsquared) {
                return;
            }

            var legh = Math.sqrt(leglsquared - halfspansquared);
            var xmidpoint = p2.x - p1.x;
            var zmidpoint = p2.z - p1.z;
            var pos = [p1.x, p1.y, p1.z, xmidpoint, legh, zmidpoint, p2.x, p2.y, p2.z];

            for (var i = 0; i < 8; i++) {
                var delta = i * 0.1;
                var newpos = pos[0] + ' ' + (pos[1] - delta) + ' ' + pos[2] +
                    ' ' + pos[3] + ' ' + (pos[4] - delta) + ' ' + pos[5] +
                    ' ' + pos[6] + ' ' + pos[7] + ' ' + pos[8];
                var line = document.getElementById(leg + 'c' + i);
                line.firstElementChild.setAttribute('point', newpos);
            }
        }

        function updateLegs(leg1pos, leg2pos, leg3pos, leg4pos) {
            try {
                checkLeg('leg1', leg1a, leg1pos);
                checkLeg('leg2', leg2a, leg2pos);
                checkLeg('leg3', leg3a, leg3pos);
                checkLeg('leg4', leg4a, leg4pos);
            } catch (ex) {
                throw (ex);
            }
            updateLeg('leg1', leg1a, leg1pos);
            updateLeg('leg2', leg2a, leg2pos);
            updateLeg('leg3', leg3a, leg3pos);
            updateLeg('leg4', leg4a, leg4pos);
        }
        function resetPos() {
            resetCoords();
            socket.emit('Activate', 'test');
            
        }

        function resetCoords() {
            var translationValue = document.getElementById('XtranslationHandleTransform').getFieldValue('translation');

            // reset all the  elements
            translationValue.x = xoffset = 0;
            translationValue.y = yoffset = 0;;
            translationValue.z = zoffset = 0;;
            document.getElementById('XtranslationHandleTransform').setFieldValue('translation', translationValue);
            document.getElementById('YtranslationHandleTransform').setFieldValue('translation', translationValue);
            document.getElementById('ZtranslationHandleTransform').setFieldValue('translation', translationValue);

            document.getElementById('rotationHandleTransform').setFieldValue('translation', translationValue);
            document.getElementById('quadrupedTranslation').setFieldValue('translation', translationValue);
            currentGizmoRotation = new x3dom.fields.SFMatrix4f();
            currentGizmoRotationOffset = new x3dom.fields.SFMatrix4f();
            applyRotationGizmoTransformations("");
        }

        function handleSlider(color, axisRotation, value) {
            var sensorToWorldMatrix, translationValue;
            var slider;
            var command;

            //convert the sensor's output from sensor coordinates to world coordinates (i.e., include its 'axisRotation')
            sensorToWorldMatrix = x3dom.fields.SFMatrix4f.parseRotation(axisRotation);
            translationValue = sensorToWorldMatrix.multMatrixVec(value);

            //transform the affected element
            if (color === 'RED') {
                document.getElementById('XtranslationHandleTransform').setFieldValue('translation', translationValue);
                xoffset = translationValue.x;
                slider = Math.abs(xoffset * 18.75);
                command = 'Move Y';
            } else if (color === 'BLUE') {
                document.getElementById('YtranslationHandleTransform').setFieldValue('translation', translationValue);
                yoffset = translationValue.y;
                slider = (yoffset * 19.35) - 15;
                command = 'Move Z';
            } else { /* GREEN */
                document.getElementById('ZtranslationHandleTransform').setFieldValue('translation', translationValue);
                zoffset = translationValue.z;
                slider = Math.abs(zoffset * 18.75);
                command = 'Move X';
            }
            translationValue.x = xoffset;
            translationValue.y = yoffset;
            translationValue.z = zoffset;
            if (applyRotationGizmoTransformations("")) {
                socket.emit(command, slider);
                document.getElementById('rotationHandleTransform').setFieldValue('translation', translationValue);
                document.getElementById('quadrupedTranslation').setFieldValue('translation', translationValue);
                return (true);
            } else {
                return (false);
            }
        }
        /*
         * Callback function, invoked on translation gizmo output.
         */
        function processTranslationGizmoEvent(event) {
            var color = event.target._x3domNode._DEF;
            var axisRotation = event.target.getAttribute('axisRotation');
            var value = event.value;
            var redSliderColor = document.getElementById('redSliderColor');
            var greenSliderColor = document.getElementById('greenSliderColor');
            var blueSliderColor = document.getElementById('blueSliderColor');
            var normalSliderColors = {
                RED: '.7 .4 .4',
                GREEN: '.4 .7 .4',
                BLUE: '.4 .4 .8'
            };
            var activeSliderColors = {
                RED: '1  0  0',
                GREEN: '.1  1  .1 ',
                BLUE: '0  0 1'
            };
            var elementSliderColors = {
                RED: redSliderColor,
                GREEN: greenSliderColor,
                BLUE: blueSliderColor
            };

            if (event.fieldName === 'isOver')
                return;

            if (mode === 'Rotate') {
                mode = 'Move';
                var myAudio = document.getElementById("audio" + mode);
                myAudio.play();
                resetPos();
            }
            if (event.fieldName === 'offset_changed') {
                elementSliderColors[color].setAttribute('diffusecolor', normalSliderColors[color]);
            }

            if (event.fieldName === 'translation_changed') {
                if (handleSlider(color, axisRotation, value)) {
                    elementSliderColors[color].setAttribute('diffusecolor', activeSliderColors[color]);
                } else {
                    elementSliderColors[color].setAttribute('diffusecolor', normalSliderColors[color]);
                }
            }
        }

        /*
         * Callback function, invoked on rotation gizmo output.
         */
        function processRotationGizmoEvent(event) {
            var sensorToWorldMatrix, rotationMatrixWorld;
            var currentRotation;
            var color = event.target._x3domNode._DEF;
            var command;
            var value;

            var redRingColor = document.getElementById('redRingColor');
            var blueRingColor = document.getElementById('blueRingColor');
            var activeRingColors = {
                RED: '.7 .4 .4',
                BLUE: '.4 .4 .8'
            };
            var normalRingColors = {
                RED: '1  0  0',
                BLUE: '0  0 1'
            };
            var elementRingColors = {
                RED: redRingColor,
                BLUE: blueRingColor
            };

            if (event.fieldName === 'isOver')
                return;

            if (mode === 'Move') {
                mode = 'Rotate';
                var myAudio = document.getElementById("audio" + mode);
                myAudio.play();
                resetPos();
            }

            if (event.fieldName === 'isActive' && event.value === false) {
                elementRingColors[color].setAttribute('diffusecolor', activeRingColors[color]);
                //incorporate the current rotation offset, interpreted globally, into the stored rotation value
                currentGizmoRotation = transformMatrix;

                //reset current rotation offset to zero rotation
                currentGizmoRotationOffset = new x3dom.fields.SFMatrix4f();
                applyRotationGizmoTransformations(color);
            }

            if (event.fieldName === 'rotation_changed') {
                elementRingColors[color].setAttribute('diffusecolor', normalRingColors[color]);

                //convert the sensor's output from sensor coordinates to world coordinates
                // (i.e., include its 'axisRotation')
                sensorToWorldMatrix = x3dom.fields.SFMatrix4f.parseRotation(event.target.getAttribute("axisRotation"));
                rotationMatrixWorld = sensorToWorldMatrix.mult(event.value.toMatrix());

                //create an offset that applies the current rotation in world coordinates,
                //but doesn't change the orientation of the coordinate system
                currentGizmoRotationOffset = rotationMatrixWorld.mult(sensorToWorldMatrix.inverse());
                if (applyRotationGizmoTransformations(color)) {
                    elementRingColors[color].setAttribute('diffusecolor', normalRingColors[color]);
                } else {
                    elementRingColors[color].setAttribute('diffusecolor', activeRingColors[color]);
                }
            }
        }

        /*
         * Applies the current transformations, computed from the rotation gizmo output, to the scene
         */
        function applyRotationGizmoTransformations(color) {
            var leg1init = {
                x: leg1c.x - xoffset,
                y: leg1c.y - yoffset,
                z: leg1c.z - zoffset
            };
            var leg2init = {
                x: leg2c.x - xoffset,
                y: leg2c.y - yoffset,
                z: leg2c.z - zoffset
            };
            var leg3init = {
                x: leg3c.x - xoffset,
                y: leg3c.y - yoffset,
                z: leg3c.z - zoffset
            };
            var leg4init = {
                x: leg4c.x - xoffset,
                y: leg4c.y - yoffset,
                z: leg4c.z - zoffset
            };
            var tm = currentGizmoRotationOffset.mult(currentGizmoRotation);

            if ((color === 'RED' && Math.abs(tm._21) > .25) ||
                (color === 'BLUE' && Math.abs(tm._10) > .25))
                return;

            var leg1pos = tm.inverse().multMatrixVec(leg1init);
            var leg2pos = tm.inverse().multMatrixVec(leg2init);
            var leg3pos = tm.inverse().multMatrixVec(leg3init);
            var leg4pos = tm.inverse().multMatrixVec(leg4init);

            try {
                updateLegs(leg1pos, leg2pos, leg3pos, leg4pos);
                if (mode === 'Rotate') {
                    if (color === 'RED') {
                        command = 'Rotate Y';
                        value = -40 * tm._21;
                    } else {
                        command = 'Rotate X';
                        value = 40 * tm._10;
                    }
                    socket.emit(command, -value);
                }
                //incorporate the current rotation offset, interpreted globally, into the stored rotation value
                //set matrix value in column major format, as required by the MatrixTransform node
                transformMatrix = tm;
                var quadrupedRotationNode = document.getElementById('quadrupedRotation');
                quadrupedRotationNode.setFieldValue("matrix", transformMatrix.transpose());
                return (true);
            } catch (ex) {
                //console.log(ex);
                return (false);
            }
        }
    </script>

    <div align='center' style='position: relative;'>
        <style>
            h1 {
                color: #e6b800;
                font-size: 3em;
            }
        </style>
        <h1>Freenove quadruped Robot</h1>

        <div>
            <button id='activate' value='Activate'>Activate</button>
            <button id='forward' value='Forward'>Forward</button>
            <button id='deactivate' value='Deactivate'>Deactivate</button>
        </div>
        <audio id="audioForward">
            <source src="/voice/forward.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioBackward">
            <source src="/voice/backward.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioLeft">
            <source src="/voice/left.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioRight">
            <source src="/voice/right.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioActivate">
            <source src="/voice/activate.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioDeactivate">
            <source src="/voice/deactivate.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioMove">
            <source src="/voice/move.m4a" type="audio/mpeg" />
        </audio>
        <audio id="audioRotate">
            <source src="/voice/rotate.m4a" type="audio/mpeg" />
        </audio>
        <div>
            <button id='left' value='Left'>Left</button>
            <button id='backward' value='Backward'>Backward</button>
            <button id='right' value='Right'>Right</button>
        </div>
    </div>

    <x3d id='x3dElement' showStat='false' showLog='false'
        style='position:absolute; top: 240px; width: 100%; bottom: 0; border:0'>
        <scene DEF='scene'>
            <navigationInfo type='examine'></navigationInfo>
            <viewpoint position="13.71854 12.00018 18.01263" orientation="-0.66475 0.73173 0.25059 0.81072"></viewpoint>

            <!-- quadruped SHAPE -->
            <transform id="quadrupedTranslation">
                <matrixTransform id="quadrupedRotation">
                    <transform translation='0 0 0' scale='1.0 1.0 1.0'>
                        <shape>
                            <appearance>
                                <material diffuseColor='1.0 0.75 0.0'></material>
                                <CommonSurfaceShader diffuseFacor='1 1 1' shininessFactor='.5'>
                                    <ImageTexture containerField='diffuseTexture' url='/texture/marble.jpg'></ImageTexture>
                                </CommonSurfaceShader>
                            </appearance>
                            <Box size='4 2 4'></Box>
                        </shape>
                    </transform>
                    <transform translation='2.25 .25 0' scale='1.0 1.0 1.0'>
                        <shape id='resetBox'>
                            <appearance>
                                <material diffuseColor='.4 0.4 0.6'></material>
                            </appearance>
                            <Box size='.5 .5 .5' onclick='resetPos(event)'></Box>
                        </shape>
                    </transform>
                </matrixTransform>
            </transform>

            <!-- AXES FOR BETTER ORIENTATION -->

            <transform translation='-6 -1.1 -6 ' rotation='0 1 0 1.57'>
                <shape>
                    <appearance>
                        <material id='coaster1' diffuseColor='0.9 0.9 0.9'></material>
                    </appearance>
                    <cylinder radius='.55' height='.1'></cylinder>
                </shape>
            </transform>
            <transform translation=' 6 -1.1 -6 ' rotation='0 1 0 1.57'>
                <shape>
                    <appearance>
                        <material id='coaster2' diffuseColor='0.9 0.9 0.9'></material>
                    </appearance>
                    <cylinder radius='.55' height='.1'></cylinder>
                </shape>
            </transform>
            <transform translation='-6 -1.1  6 ' rotation='0 1 0 1.57'>
                <shape>
                    <appearance>
                        <material id='coaster3' diffuseColor='0.9 0.9 0.9'></material>
                    </appearance>
                    <cylinder radius='.55' height='.1'></cylinder>
                </shape>
            </transform>
            <transform translation=' 6 -1.1  6 ' rotation='0 1 0 1.57'>
                <shape>
                    <appearance>
                        <material id='coaster4' diffuseColor='0.9 0.9 0.9'></material>
                    </appearance>
                    <cylinder radius='.55' height='.1'></cylinder>
                </shape>
            </transform>
            <transform>
                <shape>
                    <appearance>
                        <material id='line1' emissiveColor='1 .3 .3'></material>
                        <LineProperties linewidthScaleFactor=2 containerField="lineProperties"></LineProperties>
                    </appearance>
                    <LineSet>
                        <Coordinate point=' -8 -8 -8 8 -8 -8'></Coordinate>
                    </LineSet>
                </shape>
            </transform>
            <transform translation='2.725 -8 -8' rotation='0 0 1 1.57'>
                <shape>
                    <appearance>
                        <material id='stopper1' diffuseColor='0.3 0.3 0.3'></material>
                    </appearance>
                    <cylinder radius='.25' height='.25'></cylinder>
                </shape>
            </transform>
            <transform translation='-2.725 -8 -8' rotation='0 0 1 1.57'>
                <shape>
                    <appearance>
                        <material id='stopper2' diffuseColor='0.3 0.3 0.3'></material>
                        <LineProperties linewidthScaleFactor=2 containerField="lineProperties"></LineProperties>
                    </appearance>
                    <cylinder radius='.25' height='.25'></cylinder>
                </shape>
            </transform>
            <transform>
                <shape>
                    <appearance>
                        <material id='line2' emissiveColor='.1 .7 .1'></material>
                        <LineProperties linewidthScaleFactor=2 containerField="lineProperties"></LineProperties>
                    </appearance>
                    <LineSet>
                        <Coordinate point=' -8 -8 -8 -8 -8 8'></Coordinate>
                    </LineSet>
                </shape>
            </transform>
            <transform translation='-8 4.25 -8' rotation='0 1 0 1.57'>
                <shape>
                    <appearance>
                        <material id='stopper3' diffuseColor='0.3 0.3 0.3'></material>
                    </appearance>
                    <cylinder radius='.25' height='.25'></cylinder>
                </shape>
            </transform>
            <transform translation='-8 -1.125 -8' rotation='0 1 0 1.57'>
                <shape>
                    <appearance>
                        <material id='stopper4' diffuseColor='0.3 0.3 0.3'></material>
                        <LineProperties linewidthScaleFactor=2 containerField="lineProperties"></LineProperties>
                    </appearance>
                    <cylinder radius='.25' height='.25'></cylinder>
                </shape>
            </transform>
            <transform>
                <shape>
                    <appearance>
                        <material id='line3' emissiveColor='.3 .3 1'></material>
                        <LineProperties linewidthScaleFactor=2 containerField="lineProperties"></LineProperties>
                    </appearance>
                    <LineSet>
                        <Coordinate point=' -8 -8 -8 -8 8 -8'></Coordinate>
                    </LineSet>
                </shape>
            </transform>
            <transform translation='-8 -8 2.725 ' rotation='1 0 0 1.57'>
                <shape>
                    <appearance>
                        <material id='stopper5' diffuseColor='0.3 0.3 0.3'></material>
                    </appearance>
                    <cylinder radius='.25' height='.25'></cylinder>
                </shape>
            </transform>
            <transform translation='-8 -8 -2.725' rotation='1 0 0 1.57'>
                <shape>
                    <appearance>
                        <material id='stopper6' diffuseColor='0.3 0.3 0.3'></material>
                        <LineProperties linewidthScaleFactor=2 containerField="lineProperties"></LineProperties>
                    </appearance>
                    <cylinder radius='.25' height='.25'></cylinder>
                </shape>
            </transform>

            <!-- TRANSLATION GIZMO (CONTAINING PLANE SENSOR AND SENSOR GEOMETRY) -->
            <group>
                <planeSensor id='redSlider' DEF='RED' autoOffset='true' axisRotation='1 0 0 -1.57' minPosition='-1.6 0' maxPosition='1.6 0'
                    onoutputchange='processTranslationGizmoEvent(event)'>
                </planeSensor>

                <transform id='XtranslationHandleTransform'>
                    <transform translation='0 -8 -8' rotation='0 1 0 1.57'>
                        <transform rotation='1 0 0 -1.57'>
                            <shape>
                                <appearance>
                                    <material id='redSliderColor' diffuseColor='.7 .4 .4'></material>
                                </appearance>
                                <cylinder radius='.75' height='2'></cylinder>
                            </shape>
                        </transform>
                    </transform>
                </transform>
            </group>

            <!-- TRANSLATION GIZMO (CONTAINING PLANE SENSOR AND SENSOR GEOMETRY) -->
            <group>
                <planeSensor id='greenSlider' DEF='GREEN' autoOffset='true' axisRotation='0 1 0 -1.57' minPosition='-1.6 0' maxPosition='1.6 0'
                    onoutputchange='processTranslationGizmoEvent(event)'>
                </planeSensor>

                <transform id='ZtranslationHandleTransform'>
                    <transform translation='-8 -8 0' rotation='0 0 1 1.57'>
                        <transform rotation='1 0 0 -1.57'>
                            <shape>
                                <appearance>
                                    <material id='greenSliderColor' diffuseColor='.4 .7 .4'></material>
                                </appearance>
                                <cylinder radius='.75' height='2'></cylinder>
                            </shape>
                        </transform>
                    </transform>
                </transform>
            </group>

            <!-- TRANSLATION GIZMO (CONTAINING PLANE SENSOR AND SENSOR GEOMETRY) -->
            <group>
                <planeSensor id='blueSlider' DEF='BLUE' autoOffset='true' axisRotation='0 0 1 -1.57' minPosition='-3.1' maxPosition='0' onoutputchange='processTranslationGizmoEvent(event)'>
                </planeSensor>

                <transform id='YtranslationHandleTransform'>
                    <transform translation='-8 0 -8' rotation='1 0 0 1.57'>
                        <transform rotation='1 0 0 -1.57'>
                            <shape>
                                <appearance>
                                    <material id='blueSliderColor' diffuseColor='.4 .4 .8'></material>
                                </appearance>
                                <cylinder radius='.75' height='2'></cylinder>
                            </shape>
                        </transform>
                    </transform>
                </transform>
            </group>

            <!-- BEGIN OF ROTATION GIZMO (CONTAINING CYLINDER SENSORS AND SENSOR GEOMETRY) -->
            <transform id='rotationHandleTransform'>

                <!-- Rotation Handle X -->
                <group>
                    <cylinderSensor id='redRing' DEF='RED' autoOffset='false' axisRotation='0 0 1
-1.57' onoutputchange='processRotationGizmoEvent(event);'>
                    </cylinderSensor>

                    <transform>
                        <transform scale='2.5 5 5'>
                            <shape>
                                <appearance DEF='RED_APP'>
                                    <material id='redRingColor' diffuseColor='.7 .4 .4'></material>
                                </appearance>
                                <indexedtriangleset solid="true" normalpervertex="true" index="0 1 2 0 2 3 4 5 6 4 6 7 8 9 10 8 10 11 12 0 3 12 3 13 14 4 7 14 7 15 16 8 11 16 11 17 18 14 15 18 15 19 20 16 17 20 17 21 22 18 19 22 19 23 24 20 21 24 21 25 26 22 23 26 23 27 28 24 25 28 25 29 1 26 27 1 27 2 5 28 29 5 29 6 27 23 30 27 30 31 29 25 32 29 32 33 2 27 31 2 31 34 6 29 33 6 33 35 3 2 34 3 34 36 7 6 35 7 35 37 11 10 38 11 38 39 13 3 36 13 36 40 15 7 37 15 37 41 17 11 39 17 39 42 19 15 41 19 41 43 21 17 42 21 42 44 23 19 43 23 43 30 25 21 44 25 44 32 45 46 47 45 47 48 49 50 51 49 51 52 53 45 48 53 48 54 55 49 52 55 52 56 57 53 54 57 54 58 59 55 56 59 56 60 61 57 58 61 58 62 63 59 60 63 60 64 65 61 62 65 62 66 67 63 64 67 64 68 69 70 71 69 71 72 73 65 66 73 66 74 46 67 68 46 68 47 50 69 72 50 72 51 66 62 75 66 75 76 68 64 77 68 77 78 72 71 79 72 79 80 74 66 76 74 76 81 47 68 78 47 78 82 51 72 80 51 80 83 48 47 82 48 82 84 52 51 83 52 83 85 54 48 84 54 84 86 56 52 85 56 85 87 58 54 86 58 86 88 60 56 87 60 87 89 62 58 88 62 88 75 64 60 89 64 89 77 13 90 91 13 91 12 70 92 93 70 93 71 9 94 93 9 93 10 90 13 40 90 40 95 74 90 95 74 95 73 94 79 71 94 71 93 90 74 81 90 81 91 92 38 10 92 10 93 ">
                                    <coordinate point="-0.126178 0.375330 -0.923880 -0.126178 0.544895 -0.831470 0.000000 0.555570 -0.831470 0.000000 0.382684 -0.923880 -0.126178 0.980785 0.000000 -0.126178 0.961940 0.195090 0.000000 0.980785 0.195090 0.000000 1.000000 0.000000 -0.126178 0.375331 0.923880 -0.126178 0.191342 0.980785 0.000000 0.195091 0.980785 0.000000 0.382684 0.923880 -0.126178 0.191342 -0.980785 0.000000 0.195090 -0.980785 -0.126178 0.961940 -0.195090 0.000000 0.980785 -0.195090 -0.126178 0.544895 0.831470 0.000000 0.555570 0.831470 -0.126178 0.906128 -0.382683 0.000000 0.923880 -0.382683 -0.126178 0.693520 0.707107 0.000000 0.707107 0.707107 -0.126178 0.815493 -0.555570 0.000000 0.831470 -0.555570 -0.126178 0.815493 0.555570 0.000000 0.831470 0.555570 -0.126178 0.693520 -0.707107 0.000000 0.707107 -0.707107 -0.126178 0.906128 0.382683 0.000000 0.923880 0.382683 0.126178 0.815493 -0.555570 0.126178 0.693520 -0.707107 0.126178 0.815493 0.555570 0.126178 0.906128 0.382683 0.126178 0.544895 -0.831470 0.126178 0.961940 0.195090 0.126178 0.375330 -0.923880 0.126178 0.980785 0.000000 0.126178 0.191342 0.980785 0.126178 0.375330 0.923880 0.126178 0.191342 -0.980785 0.126178 0.961940 -0.195090 0.126178 0.544895 0.831470 0.126178 0.906128 -0.382683 0.126178 0.693520 0.707107 0.126178 -0.906128 -0.382683 0.126178 -0.961940 -0.195090 0.000000 -0.980785 -0.195090 0.000000 -0.923880 -0.382683 0.126178 -0.693520 0.707107 0.126178 -0.544895 0.831470 0.000000 -0.555570 0.831470 0.000000 -0.707107 0.707107 0.126178 -0.815493 -0.555570 0.000000 -0.831469 -0.555570 0.126178 -0.815493 0.555570 0.000000 -0.831469 0.555570 0.126178 -0.693520 -0.707107 0.000000 -0.707107 -0.707107 0.126178 -0.906127 0.382683 0.000000 -0.923879 0.382683 0.126178 -0.544895 -0.831470 0.000000 -0.555570 -0.831470 0.126178 -0.961940 0.195090 0.000000 -0.980785 0.195090 0.126178 -0.375330 -0.923880 0.000000 -0.382683 -0.923880 0.126178 -0.980785 0.000000 0.000000 -1.000000 0.000000 0.126178 -0.375330 0.923880 0.126178 -0.191342 0.980785 0.000000 -0.195090 0.980785 0.000000 -0.382684 0.923880 0.126178 -0.191342 -0.980785 0.000000 -0.195090 -0.980785 -0.126178 -0.544895 -0.831470 -0.126178 -0.375330 -0.923880 -0.126178 -0.961939 0.195090 -0.126178 -0.980785 0.000000 -0.126178 -0.191342 0.980785 -0.126178 -0.375330 0.923880 -0.126178 -0.191342 -0.980785 -0.126178 -0.961939 -0.195090 -0.126178 -0.544895 0.831470 -0.126178 -0.906127 -0.382683 -0.126178 -0.693520 0.707107 -0.126178 -0.815493 -0.555570 -0.126178 -0.815493 0.555570 -0.126178 -0.693520 -0.707107 -0.126178 -0.906127 0.382683 0.000000 0.000000 -1.012271 -0.126178 0.000000 -1.012271 0.126178 0.000000 1.012271 0.000000 0.000000 1.012271 -0.126178 0.000000 1.012271 0.126178 0.000000 -1.012271 "
                                    />
                                    <normal vector="-0.023133 0.382550 -0.923643 -0.047182 0.554918 -0.830561 0.000000 0.562792 -0.826563 0.000000 0.388867 -0.921262 -0.149113 0.988800 0.000000 -0.143559 0.970611 0.193060 0.000000 0.981445 0.191626 0.000000 1.000000 0.000000 -0.023133 0.382550 0.923643 -0.007538 0.226142 0.974059 0.000000 0.228553 0.973510 0.000000 0.388867 0.921262 -0.007538 0.226142 -0.974059 0.000000 0.228553 -0.973510 -0.143559 0.970611 -0.193060 0.000000 0.981445 -0.191626 -0.047182 0.554918 0.830561 0.000000 0.562792 0.826563 -0.127689 0.916288 -0.379559 0.000000 0.926359 -0.376629 -0.075533 0.705039 0.705100 0.000000 0.713675 0.700430 -0.103824 0.826930 -0.552568 0.000000 0.836207 -0.548387 -0.103824 0.826930 0.552568 0.000000 0.836207 0.548387 -0.075533 0.705039 -0.705100 0.000000 0.713675 -0.700430 -0.127689 0.916288 0.379559 0.000000 0.926359 0.376629 0.103824 0.826930 -0.552568 0.075533 0.705039 -0.705100 0.103824 0.826930 0.552568 0.127689 0.916288 0.379559 0.047182 0.554918 -0.830561 0.143559 0.970611 0.193060 0.023133 0.382550 -0.923643 0.149113 0.988800 0.000000 0.007538 0.226142 0.974059 0.023133 0.382550 0.923643 0.007538 0.226142 -0.974059 0.143559 0.970611 -0.193060 0.047182 0.554918 0.830561 0.127689 0.916288 -0.379559 0.075533 0.705039 0.705100 0.127689 -0.916288 -0.379559 0.143559 -0.970611 -0.193060 0.000000 -0.981445 -0.191626 0.000000 -0.926359 -0.376629 0.075533 -0.705039 0.705100 0.047182 -0.554918 0.830561 0.000000 -0.562792 0.826563 0.000000 -0.713706 0.700430 0.103824 -0.826930 -0.552568 0.000000 -0.836207 -0.548387 0.103824 -0.826960 0.552568 0.000000 -0.836207 0.548387 0.075533 -0.705039 -0.705100 0.000000 -0.713706 -0.700430 0.127689 -0.916288 0.379559 0.000000 -0.926359 0.376629 0.047182 -0.554918 -0.830561 0.000000 -0.562792 -0.826563 0.143559 -0.970611 0.193060 0.000000 -0.981445 0.191626 0.023133 -0.382550 -0.923643 0.000000 -0.388867 -0.921262 0.149113 -0.988800 0.000000 0.000000 -1.000000 0.000000 0.023133 -0.382550 0.923643 0.007538 -0.226142 0.974059 0.000000 -0.228553 0.973510 0.000000 -0.388867 0.921262 0.007538 -0.226142 -0.974059 0.000000 -0.228553 -0.973510 -0.047182 -0.554918 -0.830561 -0.023133 -0.382550 -0.923643 -0.143559 -0.970611 0.193060 -0.149113 -0.988800 0.000000 -0.007538 -0.226142 0.974059 -0.023133 -0.382550 0.923643 -0.007538 -0.226142 -0.974059 -0.143559 -0.970611 -0.193060 -0.047182 -0.554918 0.830561 -0.127689 -0.916288 -0.379559 -0.075533 -0.705039 0.705100 -0.103824 -0.826930 -0.552568 -0.103824 -0.826960 0.552568 -0.075533 -0.705039 -0.705100 -0.127689 -0.916288 0.379559 0.000000 0.000000 -1.000000 -0.002411 0.000000 -0.999969 0.002411 0.000000 0.999969 0.000000 0.000000 1.000000 -0.002411 0.000000 0.999969 0.002411 0.000000 -0.999969 "
                                    />
                                </indexedtriangleset>
                            </shape>
                        </transform>
                    </transform>
                </group>

                <!-- Rotation Handle Z -->
                <group>
                    <cylinderSensor id='blueRing' DEF='BLUE' autoOffset='false' axisRotation='1 0 0
-1.57' onoutputchange='processRotationGizmoEvent(event);'>
                    </cylinderSensor>

                    <transform>
                        <transform scale='2.5 5.1 5.1' rotation='0 1 0 -1.57'>
                            <shape>
                                <appearance DEF='BLUE_APP'>
                                    <material id='blueRingColor' diffuseColor='0.3 0.3 .8'></material>
                                </appearance>
                                <indexedtriangleset solid="true" normalpervertex="true" index="0 1 2 0 2 3 4 5 6 4 6 7 8 9 10 8 10 11 12 0 3 12 3 13 14 4 7 14 7 15 16 8 11 16 11 17 18 14 15 18 15 19 20 16 17 20 17 21 22 18 19 22 19 23 24 20 21 24 21 25 26 22 23 26 23 27 28 24 25 28 25 29 1 26 27 1 27 2 5 28 29 5 29 6 27 23 30 27 30 31 29 25 32 29 32 33 2 27 31 2 31 34 6 29 33 6 33 35 3 2 34 3 34 36 7 6 35 7 35 37 11 10 38 11 38 39 13 3 36 13 36 40 15 7 37 15 37 41 17 11 39 17 39 42 19 15 41 19 41 43 21 17 42 21 42 44 23 19 43 23 43 30 25 21 44 25 44 32 45 46 47 45 47 48 49 50 51 49 51 52 53 45 48 53 48 54 55 49 52 55 52 56 57 53 54 57 54 58 59 55 56 59 56 60 61 57 58 61 58 62 63 59 60 63 60 64 65 61 62 65 62 66 67 63 64 67 64 68 69 70 71 69 71 72 73 65 66 73 66 74 46 67 68 46 68 47 50 69 72 50 72 51 66 62 75 66 75 76 68 64 77 68 77 78 72 71 79 72 79 80 74 66 76 74 76 81 47 68 78 47 78 82 51 72 80 51 80 83 48 47 82 48 82 84 52 51 83 52 83 85 54 48 84 54 84 86 56 52 85 56 85 87 58 54 86 58 86 88 60 56 87 60 87 89 62 58 88 62 88 75 64 60 89 64 89 77 13 90 91 13 91 12 70 92 93 70 93 71 9 94 93 9 93 10 90 13 40 90 40 95 74 90 95 74 95 73 94 79 71 94 71 93 90 74 81 90 81 91 92 38 10 92 10 93 ">
                                    <coordinate point="-0.126178 0.375330 -0.923880 -0.126178 0.544895 -0.831470 0.000000 0.555570 -0.831470 0.000000 0.382684 -0.923880 -0.126178 0.980785 0.000000 -0.126178 0.961940 0.195090 0.000000 0.980785 0.195090 0.000000 1.000000 0.000000 -0.126178 0.375331 0.923880 -0.126178 0.191342 0.980785 0.000000 0.195091 0.980785 0.000000 0.382684 0.923880 -0.126178 0.191342 -0.980785 0.000000 0.195090 -0.980785 -0.126178 0.961940 -0.195090 0.000000 0.980785 -0.195090 -0.126178 0.544895 0.831470 0.000000 0.555570 0.831470 -0.126178 0.906128 -0.382683 0.000000 0.923880 -0.382683 -0.126178 0.693520 0.707107 0.000000 0.707107 0.707107 -0.126178 0.815493 -0.555570 0.000000 0.831470 -0.555570 -0.126178 0.815493 0.555570 0.000000 0.831470 0.555570 -0.126178 0.693520 -0.707107 0.000000 0.707107 -0.707107 -0.126178 0.906128 0.382683 0.000000 0.923880 0.382683 0.126178 0.815493 -0.555570 0.126178 0.693520 -0.707107 0.126178 0.815493 0.555570 0.126178 0.906128 0.382683 0.126178 0.544895 -0.831470 0.126178 0.961940 0.195090 0.126178 0.375330 -0.923880 0.126178 0.980785 0.000000 0.126178 0.191342 0.980785 0.126178 0.375330 0.923880 0.126178 0.191342 -0.980785 0.126178 0.961940 -0.195090 0.126178 0.544895 0.831470 0.126178 0.906128 -0.382683 0.126178 0.693520 0.707107 0.126178 -0.906128 -0.382683 0.126178 -0.961940 -0.195090 0.000000 -0.980785 -0.195090 0.000000 -0.923880 -0.382683 0.126178 -0.693520 0.707107 0.126178 -0.544895 0.831470 0.000000 -0.555570 0.831470 0.000000 -0.707107 0.707107 0.126178 -0.815493 -0.555570 0.000000 -0.831469 -0.555570 0.126178 -0.815493 0.555570 0.000000 -0.831469 0.555570 0.126178 -0.693520 -0.707107 0.000000 -0.707107 -0.707107 0.126178 -0.906127 0.382683 0.000000 -0.923879 0.382683 0.126178 -0.544895 -0.831470 0.000000 -0.555570 -0.831470 0.126178 -0.961940 0.195090 0.000000 -0.980785 0.195090 0.126178 -0.375330 -0.923880 0.000000 -0.382683 -0.923880 0.126178 -0.980785 0.000000 0.000000 -1.000000 0.000000 0.126178 -0.375330 0.923880 0.126178 -0.191342 0.980785 0.000000 -0.195090 0.980785 0.000000 -0.382684 0.923880 0.126178 -0.191342 -0.980785 0.000000 -0.195090 -0.980785 -0.126178 -0.544895 -0.831470 -0.126178 -0.375330 -0.923880 -0.126178 -0.961939 0.195090 -0.126178 -0.980785 0.000000 -0.126178 -0.191342 0.980785 -0.126178 -0.375330 0.923880 -0.126178 -0.191342 -0.980785 -0.126178 -0.961939 -0.195090 -0.126178 -0.544895 0.831470 -0.126178 -0.906127 -0.382683 -0.126178 -0.693520 0.707107 -0.126178 -0.815493 -0.555570 -0.126178 -0.815493 0.555570 -0.126178 -0.693520 -0.707107 -0.126178 -0.906127 0.382683 0.000000 0.000000 -1.012271 -0.126178 0.000000 -1.012271 0.126178 0.000000 1.012271 0.000000 0.000000 1.012271 -0.126178 0.000000 1.012271 0.126178 0.000000 -1.012271 "
                                    />
                                    <normal vector="-0.023133 0.382550 -0.923643 -0.047182 0.554918 -0.830561 0.000000 0.562792 -0.826563 0.000000 0.388867 -0.921262 -0.149113 0.988800 0.000000 -0.143559 0.970611 0.193060 0.000000 0.981445 0.191626 0.000000 1.000000 0.000000 -0.023133 0.382550 0.923643 -0.007538 0.226142 0.974059 0.000000 0.228553 0.973510 0.000000 0.388867 0.921262 -0.007538 0.226142 -0.974059 0.000000 0.228553 -0.973510 -0.143559 0.970611 -0.193060 0.000000 0.981445 -0.191626 -0.047182 0.554918 0.830561 0.000000 0.562792 0.826563 -0.127689 0.916288 -0.379559 0.000000 0.926359 -0.376629 -0.075533 0.705039 0.705100 0.000000 0.713675 0.700430 -0.103824 0.826930 -0.552568 0.000000 0.836207 -0.548387 -0.103824 0.826930 0.552568 0.000000 0.836207 0.548387 -0.075533 0.705039 -0.705100 0.000000 0.713675 -0.700430 -0.127689 0.916288 0.379559 0.000000 0.926359 0.376629 0.103824 0.826930 -0.552568 0.075533 0.705039 -0.705100 0.103824 0.826930 0.552568 0.127689 0.916288 0.379559 0.047182 0.554918 -0.830561 0.143559 0.970611 0.193060 0.023133 0.382550 -0.923643 0.149113 0.988800 0.000000 0.007538 0.226142 0.974059 0.023133 0.382550 0.923643 0.007538 0.226142 -0.974059 0.143559 0.970611 -0.193060 0.047182 0.554918 0.830561 0.127689 0.916288 -0.379559 0.075533 0.705039 0.705100 0.127689 -0.916288 -0.379559 0.143559 -0.970611 -0.193060 0.000000 -0.981445 -0.191626 0.000000 -0.926359 -0.376629 0.075533 -0.705039 0.705100 0.047182 -0.554918 0.830561 0.000000 -0.562792 0.826563 0.000000 -0.713706 0.700430 0.103824 -0.826930 -0.552568 0.000000 -0.836207 -0.548387 0.103824 -0.826960 0.552568 0.000000 -0.836207 0.548387 0.075533 -0.705039 -0.705100 0.000000 -0.713706 -0.700430 0.127689 -0.916288 0.379559 0.000000 -0.926359 0.376629 0.047182 -0.554918 -0.830561 0.000000 -0.562792 -0.826563 0.143559 -0.970611 0.193060 0.000000 -0.981445 0.191626 0.023133 -0.382550 -0.923643 0.000000 -0.388867 -0.921262 0.149113 -0.988800 0.000000 0.000000 -1.000000 0.000000 0.023133 -0.382550 0.923643 0.007538 -0.226142 0.974059 0.000000 -0.228553 0.973510 0.000000 -0.388867 0.921262 0.007538 -0.226142 -0.974059 0.000000 -0.228553 -0.973510 -0.047182 -0.554918 -0.830561 -0.023133 -0.382550 -0.923643 -0.143559 -0.970611 0.193060 -0.149113 -0.988800 0.000000 -0.007538 -0.226142 0.974059 -0.023133 -0.382550 0.923643 -0.007538 -0.226142 -0.974059 -0.143559 -0.970611 -0.193060 -0.047182 -0.554918 0.830561 -0.127689 -0.916288 -0.379559 -0.075533 -0.705039 0.705100 -0.103824 -0.826930 -0.552568 -0.103824 -0.826960 0.552568 -0.075533 -0.705039 -0.705100 -0.127689 -0.916288 0.379559 0.000000 0.000000 -1.000000 -0.002411 0.000000 -0.999969 0.002411 0.000000 0.999969 0.000000 0.000000 1.000000 -0.002411 0.000000 0.999969 0.002411 0.000000 -0.999969 "
                                    />
                                </indexedtriangleset>
                            </shape>
                        </transform>
                    </transform>
                </group>

            </transform>
            <!-- END OF ROTATION GIZMO -->

        </scene>
    </x3d>
</body>

</html>